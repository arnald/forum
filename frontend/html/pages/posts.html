{{ define "content" }}
<div class="posts-container">
  <div class="posts-header">
    <h1 class="forum-title">Forum Posts</h1>
    <div class="header-actions">
      <button id="manage-categories-btn" class="btn btn-secondary">Manage Categories</button>
      <button id="create-post-btn" class="btn btn-primary">Create New Post</button>
    </div>
  </div>

  <!-- Category Filter Section -->
  <div class="category-filter-section">
    <h3>Filter by Category</h3>
    <div class="category-filters">
      <button class="category-filter-btn active" data-category="">All Posts</button>
      <div id="category-filter-buttons">
        <!-- Category filter buttons will be loaded here -->
      </div>
    </div>
  </div>

  <!-- Create Post Modal -->
  <div id="create-post-modal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Create New Post</h2>
        <span class="close">&times;</span>
      </div>
      <form id="create-post-form">
        <div class="form-group">
          <label for="post-title">Title:</label>
          <input type="text" id="post-title" name="title" required>
        </div>
        <div class="form-group">
          <label for="post-content">Content:</label>
          <textarea id="post-content" name="content" rows="10" required></textarea>
        </div>
        <div class="form-group">
          <label for="post-categories">Categories (comma-separated):</label>
          <input type="text" id="post-categories" name="categories" placeholder="e.g., General, Discussion">
        </div>
        <div class="form-actions">
          <button type="submit" class="btn btn-primary">Create Post</button>
          <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Category Management Modal -->
  <div id="category-management-modal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Manage Categories</h2>
        <span class="close" onclick="closeCategoryModal()">&times;</span>
      </div>
      <div class="modal-body">
        <!-- Create Category Form -->
        <div class="create-category-section">
          <h3>Create New Category</h3>
          <form id="create-category-form">
            <div class="form-group">
              <label for="category-name">Category Name:</label>
              <input type="text" id="category-name" name="name" required>
            </div>
            <div class="form-group">
              <label for="category-description">Description:</label>
              <textarea id="category-description" name="description" rows="3"></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Create Category</button>
          </form>
        </div>

        <!-- Categories List -->
        <div class="categories-list-section">
          <h3>Existing Categories</h3>
          <div id="categories-list">
            <!-- Categories will be loaded here -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Posts List -->
  <div id="posts-list" class="posts-list">
    <!-- Posts will be loaded here dynamically -->
  </div>
</div>

<script>
// Load posts when page loads
document.addEventListener('DOMContentLoaded', function() {
  loadPosts();
});

// Modal functionality
document.getElementById('create-post-btn').addEventListener('click', function() {
  document.getElementById('create-post-modal').style.display = 'block';
});

document.querySelector('.close').addEventListener('click', function() {
  closeModal();
});

function closeModal() {
  document.getElementById('create-post-modal').style.display = 'none';
  document.getElementById('create-post-form').reset();
}

// Create post form submission
document.getElementById('create-post-form').addEventListener('submit', function(e) {
  e.preventDefault();

  const title = document.getElementById('post-title').value;
  const content = document.getElementById('post-content').value;
  const categoriesStr = document.getElementById('post-categories').value;
  const categories = categoriesStr ? categoriesStr.split(',').map(c => c.trim()) : [];

  fetch('/api/v1/posts', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-User-ID': getUserId() // You'll need to implement this function
    },
    body: JSON.stringify({
      title: title,
      content: content,
      categories: categories
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      closeModal();
      loadPosts(); // Reload posts
    } else {
      alert('Failed to create post');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Failed to create post');
  });
});

// Load and display posts
function loadPosts() {
  fetch('/api/v1/posts/all')
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        displayPosts(data.posts);
      }
    })
    .catch(error => {
      console.error('Error loading posts:', error);
    });
}

function displayPosts(posts) {
  const postsContainer = document.getElementById('posts-list');

  if (!posts || posts.length === 0) {
    postsContainer.innerHTML = '<p class="no-posts">No posts yet. Be the first to create one!</p>';
    return;
  }

  const postsHTML = posts.map(post => `
    <div class="post-card" data-post-id="${post.ID}">
      <div class="post-header">
        <h3 class="post-title">${escapeHtml(post.Title)}</h3>
        <div class="post-meta">
          <span class="post-author">By ${escapeHtml(post.Username)}</span>
          <span class="post-date">${formatDate(post.CreatedAt)}</span>
        </div>
      </div>
      <div class="post-content">
        ${escapeHtml(post.Content).substring(0, 200)}${post.Content.length > 200 ? '...' : ''}
      </div>
      ${post.Categories && post.Categories.length > 0 ? `
        <div class="post-categories">
          ${post.Categories.map(cat => `<span class="category-tag">${escapeHtml(cat)}</span>`).join('')}
        </div>
      ` : ''}
      <div class="post-vote-stats">
        <span class="vote-score">Score: ${post.VoteScore || 0}</span>
        <span class="vote-counts">üëç ${post.LikeCount || 0} üëé ${post.DislikeCount || 0}</span>
      </div>
      <div class="post-actions">
        <div class="vote-buttons">
          <button class="btn btn-vote btn-like" onclick="castVote('${post.ID}', 'post', 'like')" id="like-post-${post.ID}">
            üëç Like
          </button>
          <button class="btn btn-vote btn-dislike" onclick="castVote('${post.ID}', 'post', 'dislike')" id="dislike-post-${post.ID}">
            üëé Dislike
          </button>
        </div>
        <div class="action-buttons">
          <button class="btn btn-small" onclick="viewPost('${post.ID}')">Read More</button>
          <button class="btn btn-small btn-secondary" onclick="toggleComments('${post.ID}')">Comments</button>
        </div>
      </div>
      <div id="comments-${post.ID}" class="comments-section" style="display: none;">
        <div class="comments-header">
          <h4>Comments</h4>
          <button class="btn btn-small btn-primary" onclick="showAddComment('${post.ID}')">Add Comment</button>
        </div>
        <div id="add-comment-${post.ID}" class="add-comment-form" style="display: none;">
          <textarea id="comment-content-${post.ID}" placeholder="Write your comment..." rows="3"></textarea>
          <div class="comment-actions">
            <button class="btn btn-small btn-primary" onclick="addComment('${post.ID}')">Post Comment</button>
            <button class="btn btn-small btn-secondary" onclick="hideAddComment('${post.ID}')">Cancel</button>
          </div>
        </div>
        <div id="comments-list-${post.ID}" class="comments-list">
          <!-- Comments will be loaded here -->
        </div>
      </div>
    </div>
  `).join('');

  postsContainer.innerHTML = postsHTML;
}

function viewPost(postId) {
  // For now, just show an alert - you can implement a detailed view later
  fetch(`/api/v1/posts/get?id=${postId}`)
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert(`Title: ${data.post.Title}\n\nContent: ${data.post.Content}`);
      }
    })
    .catch(error => {
      console.error('Error:', error);
    });
}

// Utility functions
function escapeHtml(text) {
  const map = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#039;'
  };
  return text.replace(/[&<>"']/g, function(m) { return map[m]; });
}

function formatDate(dateString) {
  const date = new Date(dateString);
  return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
}

function getUserId() {
  // This is a placeholder - you should implement proper session management
  // For now, return a dummy user ID for testing
  return 'df16d238-e4dd-4645-9101-54aed9c0fbf4';
}

// Comment functionality
function toggleComments(postId) {
  const commentsSection = document.getElementById(`comments-${postId}`);
  if (commentsSection.style.display === 'none') {
    commentsSection.style.display = 'block';
    loadComments(postId);
  } else {
    commentsSection.style.display = 'none';
  }
}

function showAddComment(postId) {
  document.getElementById(`add-comment-${postId}`).style.display = 'block';
}

function hideAddComment(postId) {
  document.getElementById(`add-comment-${postId}`).style.display = 'none';
  document.getElementById(`comment-content-${postId}`).value = '';
}

function addComment(postId) {
  const content = document.getElementById(`comment-content-${postId}`).value.trim();
  if (!content) {
    alert('Please enter a comment');
    return;
  }

  fetch('/api/v1/comments', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-User-ID': getUserId()
    },
    body: JSON.stringify({
      content: content,
      post_id: postId
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      hideAddComment(postId);
      loadComments(postId);
    } else {
      alert('Failed to add comment');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Failed to add comment');
  });
}

function addReply(postId, parentId) {
  const content = document.getElementById(`reply-content-${parentId}`).value.trim();
  if (!content) {
    alert('Please enter a reply');
    return;
  }

  fetch('/api/v1/comments', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-User-ID': getUserId()
    },
    body: JSON.stringify({
      content: content,
      post_id: postId,
      parent_id: parentId
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      hideReplyForm(parentId);
      loadComments(postId);
    } else {
      alert('Failed to add reply');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Failed to add reply');
  });
}

function loadComments(postId) {
  fetch(`/api/v1/comments/tree?post_id=${postId}`)
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        displayComments(postId, data.commentTree || []);
      }
    })
    .catch(error => {
      console.error('Error loading comments:', error);
    });
}

function displayComments(postId, commentTree) {
  const commentsContainer = document.getElementById(`comments-list-${postId}`);

  if (!commentTree || commentTree.length === 0) {
    commentsContainer.innerHTML = '<p class="no-comments">No comments yet. Be the first to comment!</p>';
    return;
  }

  const commentsHTML = commentTree.map(commentNode => renderCommentTree(commentNode, postId)).join('');
  commentsContainer.innerHTML = commentsHTML;
}

function renderCommentTree(commentNode, postId) {
  const comment = commentNode.Comment;
  const replies = commentNode.Replies || [];

  return `
    <div class="comment" data-comment-id="${comment.ID}" style="margin-left: ${comment.Level * 20}px;">
      <div class="comment-header">
        <span class="comment-author">${escapeHtml(comment.Username)}</span>
        <span class="comment-date">${formatDate(comment.CreatedAt)}</span>
      </div>
      <div class="comment-content">
        ${escapeHtml(comment.Content)}
      </div>
      <div class="comment-vote-stats">
        <span class="vote-score">Score: ${comment.VoteScore || 0}</span>
        <span class="vote-counts">üëç ${comment.LikeCount || 0} üëé ${comment.DislikeCount || 0}</span>
      </div>
      <div class="comment-actions">
        <div class="comment-vote-buttons">
          <button class="btn btn-vote-tiny btn-like" onclick="castVote('${comment.ID}', 'comment', 'like')" id="like-comment-${comment.ID}">
            üëç
          </button>
          <button class="btn btn-vote-tiny btn-dislike" onclick="castVote('${comment.ID}', 'comment', 'dislike')" id="dislike-comment-${comment.ID}">
            üëé
          </button>
        </div>
        <button class="btn btn-tiny" onclick="showReplyForm('${comment.ID}', '${postId}')">Reply</button>
      </div>
      <div id="reply-form-${comment.ID}" class="reply-form" style="display: none;">
        <textarea id="reply-content-${comment.ID}" placeholder="Write your reply..." rows="2"></textarea>
        <div class="reply-actions">
          <button class="btn btn-tiny btn-primary" onclick="addReply('${postId}', '${comment.ID}')">Post Reply</button>
          <button class="btn btn-tiny btn-secondary" onclick="hideReplyForm('${comment.ID}')">Cancel</button>
        </div>
      </div>
      ${replies.map(reply => renderCommentTree(reply, postId)).join('')}
    </div>
  `;
}

function showReplyForm(commentId, postId) {
  document.getElementById(`reply-form-${commentId}`).style.display = 'block';
}

function hideReplyForm(commentId) {
  document.getElementById(`reply-form-${commentId}`).style.display = 'none';
  document.getElementById(`reply-content-${commentId}`).value = '';
}

// Voting functionality
function castVote(targetId, targetType, voteType) {
  fetch('/api/v1/votes/cast', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-User-ID': getUserId()
    },
    body: JSON.stringify({
      target_id: targetId,
      target_type: targetType,
      vote_type: voteType
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      updateVoteButtons(targetId, targetType, data.vote_status);
      // Refresh the page data to update vote counts
      if (targetType === 'post') {
        loadPosts();
      } else {
        // For comments, find the post ID and reload comments
        const commentElement = document.querySelector(`[data-comment-id="${targetId}"]`);
        if (commentElement) {
          const postElement = commentElement.closest('[data-post-id]');
          if (postElement) {
            const postId = postElement.getAttribute('data-post-id');
            loadComments(postId);
          }
        }
      }
    } else {
      alert('Failed to cast vote');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Failed to cast vote');
  });
}

function updateVoteButtons(targetId, targetType, voteStatus) {
  const likeBtn = document.getElementById(`like-${targetType}-${targetId}`);
  const dislikeBtn = document.getElementById(`dislike-${targetType}-${targetId}`);

  if (!likeBtn || !dislikeBtn) return;

  // Reset button states
  likeBtn.classList.remove('active');
  dislikeBtn.classList.remove('active');

  // Set active state based on user's current vote
  if (voteStatus && voteStatus.user_vote) {
    if (voteStatus.user_vote.vote_type === 1) { // Like
      likeBtn.classList.add('active');
    } else if (voteStatus.user_vote.vote_type === 2) { // Dislike
      dislikeBtn.classList.add('active');
    }
  }
}
</script>

<style>
.posts-container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px;
}

.posts-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 30px;
}

.btn {
  padding: 10px 20px;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  font-size: 14px;
}

.btn-primary {
  background-color: #007bff;
  color: white;
}

.btn-secondary {
  background-color: #6c757d;
  color: white;
}

.btn-small {
  padding: 5px 10px;
  font-size: 12px;
}

.modal {
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.5);
}

.modal-content {
  background-color: white;
  margin: 5% auto;
  padding: 20px;
  border-radius: 5px;
  width: 80%;
  max-width: 600px;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.close {
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
}

.form-group {
  margin-bottom: 15px;
}

.form-group label {
  display: block;
  margin-bottom: 5px;
  font-weight: bold;
}

.form-group input,
.form-group textarea {
  width: 100%;
  padding: 8px;
  border: 1px solid #ddd;
  border-radius: 3px;
  font-size: 14px;
}

.form-actions {
  display: flex;
  gap: 10px;
  justify-content: flex-end;
}

.post-card {
  border: 1px solid #ddd;
  border-radius: 5px;
  padding: 20px;
  margin-bottom: 20px;
  background-color: white;
}

.post-header {
  margin-bottom: 10px;
}

.post-title {
  margin: 0 0 5px 0;
  color: #333;
}

.post-meta {
  color: #666;
  font-size: 12px;
}

.post-content {
  margin: 15px 0;
  line-height: 1.6;
}

.post-categories {
  margin: 10px 0;
}

.category-tag {
  background-color: #e9ecef;
  padding: 2px 8px;
  border-radius: 3px;
  font-size: 12px;
  margin-right: 5px;
}

.post-vote-stats {
  margin: 10px 0;
  display: flex;
  gap: 15px;
  font-size: 14px;
  color: #666;
}

.vote-score {
  font-weight: bold;
}

.post-actions {
  margin-top: 15px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 10px;
}

.vote-buttons {
  display: flex;
  gap: 5px;
}

.action-buttons {
  display: flex;
  gap: 5px;
}

.btn-vote {
  padding: 6px 12px;
  font-size: 13px;
  border: 1px solid #ddd;
  background-color: #f8f9fa;
  color: #333;
  transition: all 0.2s;
}

.btn-vote:hover {
  background-color: #e9ecef;
}

.btn-vote.btn-like.active {
  background-color: #28a745;
  color: white;
  border-color: #28a745;
}

.btn-vote.btn-dislike.active {
  background-color: #dc3545;
  color: white;
  border-color: #dc3545;
}

.btn-vote-tiny {
  padding: 2px 6px;
  font-size: 11px;
  border: 1px solid #ddd;
  background-color: #f8f9fa;
  color: #333;
  transition: all 0.2s;
}

.btn-vote-tiny:hover {
  background-color: #e9ecef;
}

.btn-vote-tiny.btn-like.active {
  background-color: #28a745;
  color: white;
  border-color: #28a745;
}

.btn-vote-tiny.btn-dislike.active {
  background-color: #dc3545;
  color: white;
  border-color: #dc3545;
}

.no-posts {
  text-align: center;
  color: #666;
  font-style: italic;
  padding: 40px;
}

/* Comment Styles */
.comments-section {
  margin-top: 20px;
  border-top: 1px solid #ddd;
  padding-top: 20px;
}

.comments-header {
  display: flex;
  justify-content: between;
  align-items: center;
  margin-bottom: 15px;
}

.comments-header h4 {
  margin: 0;
  color: #333;
}

.add-comment-form,
.reply-form {
  margin: 15px 0;
  padding: 15px;
  background-color: #f8f9fa;
  border-radius: 5px;
}

.add-comment-form textarea,
.reply-form textarea {
  width: 100%;
  padding: 8px;
  border: 1px solid #ddd;
  border-radius: 3px;
  font-family: inherit;
  resize: vertical;
}

.comment-actions,
.reply-actions {
  display: flex;
  gap: 10px;
  margin-top: 10px;
}

.comments-list {
  margin-top: 20px;
}

.comment {
  border: 1px solid #e0e0e0;
  border-radius: 5px;
  padding: 15px;
  margin-bottom: 10px;
  background-color: #fafafa;
}

.comment-header {
  display: flex;
  gap: 15px;
  margin-bottom: 10px;
}

.comment-author {
  font-weight: bold;
  color: #333;
}

.comment-date {
  color: #666;
  font-size: 12px;
}

.comment-content {
  margin: 10px 0;
  line-height: 1.5;
}

.comment-vote-stats {
  margin: 8px 0;
  display: flex;
  gap: 10px;
  font-size: 12px;
  color: #666;
}

.comment-actions {
  margin-top: 10px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.comment-vote-buttons {
  display: flex;
  gap: 3px;
}

.btn-tiny {
  padding: 4px 8px;
  font-size: 11px;
}

.no-comments {
  text-align: center;
  color: #666;
  font-style: italic;
  padding: 20px;
}
</style>
{{ end }}