version: '3.8'

services:
  forum:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: forum-app
    restart: unless-stopped
    ports:
      - "3001:3001"  # Frontend client
      - "8080:8080"  # Backend API
    environment:
      # Server Configuration
      SERVER_HOST: 0.0.0.0
      SERVER_PORT: 8080
      SERVER_ENVIRONMENT: development
      SERVER_API_CONTEXT_V1: /api/v1
      SERVER_READ_TIMEOUT: 10
      SERVER_WRITE_TIMEOUT: 20
      SERVER_IDLE_TIMEOUT: 30
      SERVER_TLS_CERT_FILE: certs/localhost+2.pem
      SERVER_TLS_KEY_FILE: certs/localhost+2-key.pem
      
      # Client Configuration
      CLIENT_HOST: 0.0.0.0
      CLIENT_PORT: 3001
      CLIENT_ENVIRONMENT: development
      CLIENT_TLS_CERT_FILE: certs/localhost+2.pem
      CLIENT_TLS_KEY_FILE: certs/localhost+2-key.pem
      BACKEND_URL: https://localhost:8080/api/v1
      
      # Database Configuration
      DB_DRIVER: sqlite3
      DB_PATH: db/data/forum.db
      DB_MIGRATE_ON_START: "true"
      DB_SEED_ON_START: "true"
      DB_PRAGMA: "_foreign_keys=on&_journal_mode=WAL"
      
      # Session Configuration
      SESSION_SECURE_COOKIE: "true"
      SESSION_COOKIE_SAME_SITE: Lax
      
      # Rate Limiting
      RATE_LIMIT_ENABLED: "true"
      RATE_LIMIT_REQUESTS: 100
      RATE_LIMIT_WINDOW_SECONDS: 60
      
      # OAuth (optional - add your credentials)
      GITHUB_CLIENT_ID: { INSERT HERE YOUR GITHUB CLIENT ID }
      GITHUB_CLIENT_SECRET: { INSERT HERE YOUR GITHUB CLIENT SECRET }
      GITHUB_REDIRECT_URL: https://localhost:8080/api/v1/auth/github/callback
      GITHUB_SCOPES: user,email
      FRONTEND_GITHUB_CALLBACK_URL: https://localhost:3001/auth/callback
      GOOGLE_CLIENT_ID: { INSERT HERE YOUR GOOGLE CLIENT ID }
      GOOGLE_CLIENT_SECRET: { INSERT HERE YOUR GOOGLE CLIENT SECRET }
      GOOGLE_REDIRECT_URL: https://localhost:8080/api/v1/auth/google/callback
      GOOGLE_SCOPES: https://www.googleapis.com/auth/userinfo.profile,https://www.googleapis.com/auth/userinfo.email
      GOOGLE_TOKEN_URL: https://oauth2.googleapis.com/token
      FRONTEND_GOOGLE_CALLBACK_URL: https://localhost:3001/auth/callback
    
    volumes:
      # Persistent database storage
      - forum-db:/app/db/data
      # Persistent user uploads
      - forum-uploads:/app/frontend/static/images/uploads
    
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/api/v1/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    
    networks:
      - forum-network

volumes:
  forum-db:
    driver: local
  forum-uploads:
    driver: local

networks:
  forum-network:
    driver: bridge
